---
import ContentLayout from "../../layouts/ContentLayout.astro";
import { processPostContent } from "../../libs/processPost";

const { slug } = Astro.params;
const CACHE_KEY = `post:${slug}`;
const STALE_TIME = 1000 * 60 * 5;

let cached = await CACHE_KV.get(CACHE_KEY, { type: "json" });
const now = Date.now();

let post;
let content;

if (cached) {
  post = cached.post;
  content = cached.content;

  if (now - cached.timestamp > STALE_TIME) {
    Astro.waitUntil(
      (async () => {
        const res = await fetch(import.meta.env.WP_GRAPHQL_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: `
              query SinglePost($slug: ID!) {
                post(id: $slug, idType: SLUG) {
                  title
                  excerpt
                  readingTime
                  wordCount
                  slug
                  date
                  modified
                  content
                }
              }
            `,
            variables: { slug },
          }),
        });

        const json = await res.json();
        const freshPost = json.data.post;
        const freshContent = await processPostContent(freshPost.content);

        await CACHE_KV.put(CACHE_KEY, JSON.stringify({ post: freshPost, content: freshContent, timestamp: Date.now() }));
      })()
    );
  }
} else {
  const res = await fetch(import.meta.env.WP_GRAPHQL_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      query: `
        query SinglePost($slug: ID!) {
          post(id: $slug, idType: SLUG) {
            title
            excerpt
            readingTime
            wordCount
            slug
            date
            modified
            content
          }
        }
      `,
      variables: { slug },
    }),
  });

  const json = await res.json();
  post = json.data.post;
  content = await processPostContent(post.content);

  Astro.waitUntil(
    CACHE_KV.put(CACHE_KEY, JSON.stringify({ post, content, timestamp: now }))
  );
}
---

<ContentLayout
  title={post.title}
  description={post.excerpt}
  published_at={post.date}
  lastModified={post.modified}
  readingTime={post.readingTime}
  wordsCount={post.wordCount}
  slug={post.slug}
>
  <div set:html={content} />
</ContentLayout>
