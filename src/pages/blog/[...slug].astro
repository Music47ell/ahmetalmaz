---
import ContentLayout from "../../layouts/ContentLayout.astro";
import { processPostContent } from "../../libs/processPost";

// Dynamic slug from URL
const { slug } = Astro.params;

// Fetch the single post at request time
const response = await fetch(import.meta.env.WP_GRAPHQL_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    query: `
      query SinglePost($slug: ID!) {
        post(id: $slug, idType: SLUG) {
          title
          excerpt
          readingTime
          wordCount
          slug
          date
          modified
          content
        }
      }
    `,
    variables: { slug },
  }),
});

const json = await response.json();
const post = json.data.post;
const content = await processPostContent(post.content);
---

<ContentLayout
  title={post.title}
  description={post.excerpt}
  published_at={post.date}
  lastModified={post.modified}
  readingTime={post.readingTime}
  wordsCount={post.wordCount}
  slug={post.slug}
>
  <div set:html={content} />
</ContentLayout>