---
const { slug, trackViews } = Astro.props;
const apiBaseUrl = import.meta.env.PUBLIC_API_BASE_URL;
const token = import.meta.env.PUBLIC_INSIGHT_TOKEN
---

<span data-post-views={slug} class="shrink-0"> ---</span>

<script define:vars={{ apiBaseUrl, token, slug, trackViews }} lang="ts" type="module">
	let views = 0;
	let data = { count: 0 };

	const fetchViews = async () => {
		const res = await fetch(`${apiBaseUrl}/insight/${slug}`, {
			method: "GET",
			headers: {
				"Content-Type": "application/json",
				Authorization: `Bearer ${token}`,
			},
		});

		data = await res.json();
		views = data.views === 0 ? 0 : data.views;

		const el = document.querySelector(`[data-post-views="${slug}"]`);
		el.innerHTML = views;
	};

	const options = {
		root: null,
		threshold: 0.5,
	};

	const observer = new IntersectionObserver((entries) => {
		entries.forEach((entry) => {
			if (entry.isIntersecting) {
				fetchViews();
				observer.unobserve(entry.target);
			}
		});
	}, options);

	// Target element
	const targetElement = document.querySelector(`[data-post-views="${slug}"]`);

	// Start observing the target element
	if (targetElement) {
		observer.observe(targetElement);
	}
</script>
